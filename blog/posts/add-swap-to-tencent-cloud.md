---
lastUpdate: 1545308516377
preview: 如何从马老板和马老板的嘴里省下尽可能多的钱
tags:
  - Web
---

# 为你的 XX 云添加 SWAP

目前来讲云服务器大多数都采用马云老板家的阿里云 ECS 或者马化腾老板家的腾讯云，两者从 PaaS 服务上讲都差不多，机房也都涵盖了国内外多个地区，且提供了完整的一站式域名购买/解析/备案流程，体验还是很不错的。

很多大学生冲着阿里云或者腾讯云的十几块甚至几块钱一个月的学生残废云就入了坑，我也不例外，9.9 买了腾讯云双核 1G 的残废云服务器。如果只是用来跑跑 MySQL，Redis，Nodejs Server 甚至是 MongoDB，这个残废云都属于勉强能看甚至绰绰有余的水平。毕竟更多的时候，作为一个曾经的前端，我大多数时候还是放点静态的小玩意儿。

然鹅有一天，我突然想研究研究 CI，而且好死不死选择了 GitLab 来做研究对象。作为一个有云服务器的人，当然不会满足于在虚拟机里跑一个 GitLab。上云，捣鼓捣鼓，搞定！兴冲冲的访问 gitlab 主页，然后

**502 了**

经过多方查阅资料，gitlab 出现 502 绝大多数情况下是 2 个问题造成的

> - 1.如果 gitlab 运行在现有的 nginx 环境下，而 nginx 没有权限去访问 socket 文件。

这个太好解决了，bing 一搜一大堆解决办法，要么给 nginx 组设置权限，要么简单粗暴的把整个 gitlab-rails 搞到 a+x

> - 2.资源不足

这就很麻烦了，之前虚拟机都是直接给 8G4 核玩的，没想到这货如此吃硬件。按照网上的说法把`unicorn.rb`中的 timeout 从**60 秒**提高到**600 秒**之后，gitlab 可以访问了，但是访问速度奇慢无比，而且经常伴随着 502 的出现，体验极差。

后来上腾讯云 console 一看，内存平均使用 80%+，才恍然大悟，内存爆了。原本准备忍痛掏钱给服务器升级的我，突然想起来还有一个东西叫 SWAP，然后就去网上找了教程，给服务器设置了 1G 的 SWAP。瞬间，gitlab 如丝般流畅。

> 以下内容总结自[严 47 的博客](http://www.cnblogs.com/Yan47/p/5991910.html)

腾讯云和阿里云并不会自动分 SWAP 或者挂载 SWAP，如果服务器已经在使用，则无法对虚拟磁盘进行重新分区，于是我们选择 SWAP 文件。

```bash
$ cd ~
$ mkdir swap && cd swap
$ dd if=/dev/zero of=SWAPFILE bs=1024 count=1048576
$ mkswap SWAPFILE 1048576
$ swapon SWAPFILE
```

此时 SWAPFILE 已经挂载完成，查看一下内存情况

```bash
$ free
              total        used        free      shared  buff/cache   available
Mem:        1883616     1502692       66144       42180      314780      147616
Swap:       1048572      549204      499368
```

我估摸着腾讯和阿里的 PaaS 服务器应该都是 SSD，所以 SWAP 本身的交换速率并不会对体验造成太大影响。而且我们大多数情况也不会把 I/O 密集应用跑在这种玩具云服务器上，所以 SWAP 文件理论上是无敌的。
